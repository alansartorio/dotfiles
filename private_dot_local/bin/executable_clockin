#!/bin/bash

data_dir="$XDG_DATA_HOME/clockin"
mkdir -p "$data_dir"

if [ $# -ge 1 ]; then
    command=$1
    shift
else
    command=in
fi
echo "command=$command"

workdir=$(pwd)

inside_workspace=true
while ! [ -f "$workdir/clockin" ]; do
    workdir=${workdir%/*}
    if [ -z "$workdir" ]; then
        inside_workspace=false
        break
    fi
done

echo "workdir=$workdir"
clockin_file="$workdir/clockin"

wait_for_cancellation_while_writing() {
    # idle waiting for abort from user
    #( trap exit SIGINT ; read -r -d '' _ </dev/tty )
    ( trap exit SIGINT ; dd >> "$clockin_file" )
}

date_iso() {
    date +'%Y-%m-%dT%H:%M:%S'
}

expect_workspace() {
    if [ "$inside_workspace" = false ]; then
        echo "Not inside a workspace"
        exit 1
    fi
}

case "$command" in
    "clear")
        expect_workspace
        > $clockin_file
        ;;

    "show")
        expect_workspace
        if [ -f "$clockin_file" ]; then
            cat "$clockin_file"
        else
            echo "No logs"
        fi
        ;;

    "in")
        expect_workspace
        echo "=============="
        echo "= CLOCKED IN ="
        echo "=============="
        start=`date_iso`
        printf -- "%%-%s\n" $start | tee -a "$clockin_file"
        wait_for_cancellation_while_writing
        end=`date_iso`
        printf -- "%%+%s\n\n" $end | tee -a "$clockin_file"
        ;;

    "summary")
        expect_workspace
        date_sum=$(
            cat "$clockin_file" | {
                printf "0" 
                while read line; do
                    if [[ "$line" =~ ^%([-+])(.+)$ ]]; then
                        date_num=`date --date=${BASH_REMATCH[2]} +"%s"`
                        sign=${BASH_REMATCH[1]}
                        printf -- "$sign$date_num"
                    fi
                done
                echo
            } | bc
        )
        date -d@"$date_sum" -u +"%H:%M:%S"
        ;;

    "edit")
        expect_workspace
        "${EDITOR:-vi}" "$clockin_file"
        ;;

    "link")
        if [ $# -lt 1 ]; then
            echo "Wrong number of arguments for link command"
            echo "usage: clockin link <workspace_name>"
            exit 1
        fi

        workspace_name=$1

        touch "$data_dir/$workspace_name"
        ln -s "$data_dir/$workspace_name" clockin

        ;;
esac
